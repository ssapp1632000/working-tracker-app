name: Build and Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      - name: Get version from pubspec.yaml
        id: version
        run: |
          $content = Get-Content pubspec.yaml -Raw
          if ($content -match 'version:\s*(\d+\.\d+\.\d+)') {
            echo "VERSION=$($matches[1])" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Check if release exists
        id: check_release
        run: |
          $tag = "v${{ steps.version.outputs.VERSION }}"
          $releases = gh release list --limit 100 2>$null
          if ($releases -match $tag) {
            echo "EXISTS=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "EXISTS=false" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create .env file
        if: steps.check_release.outputs.EXISTS == 'false'
        run: |
          @"
          # API
          API_BASE_URL=https://api.ssapp.site/api/v1

          # GitHub repository for update checks (format: owner/repo)
          GITHUB_REPO=${{ github.repository }}
          "@ | Out-File -FilePath .env -Encoding utf8
        shell: pwsh

      - name: Install dependencies
        if: steps.check_release.outputs.EXISTS == 'false'
        run: flutter pub get

      - name: Build Windows
        if: steps.check_release.outputs.EXISTS == 'false'
        run: flutter build windows --release

      - name: Create Release
        if: steps.check_release.outputs.EXISTS == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Version ${{ steps.version.outputs.VERSION }}
          body: |
            ## Silver Stone v${{ steps.version.outputs.VERSION }}

            Automated release from main branch.

            ### Download
            Download the Windows executable below to update your app.
          files: |
            build/windows/x64/runner/Release/silver_stone.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip - Release already exists
        if: steps.check_release.outputs.EXISTS == 'true'
        run: echo "Release v${{ steps.version.outputs.VERSION }} already exists, skipping build"
