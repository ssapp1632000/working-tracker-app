name: Build and Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      - name: Get version from pubspec.yaml
        id: version
        run: |
          $content = Get-Content pubspec.yaml -Raw
          if ($content -match 'version:\s*(\d+\.\d+\.\d+)') {
            echo "VERSION=$($matches[1])" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Check if release exists
        id: check_release
        run: |
          $tag = "v${{ steps.version.outputs.VERSION }}"
          $releases = gh release list --limit 100 2>$null
          if ($releases -match $tag) {
            echo "EXISTS=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "EXISTS=false" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create .env file
        if: steps.check_release.outputs.EXISTS == 'false'
        run: |
          @"
          # API
          API_BASE_URL=https://app.ssarchitects.ae/api/v1

          # GitHub repository for update checks (format: owner/repo)
          GITHUB_REPO=${{ github.repository }}
          "@ | Out-File -FilePath .env -Encoding utf8
        shell: pwsh

      - name: Install dependencies
        if: steps.check_release.outputs.EXISTS == 'false'
        run: flutter pub get

      - name: Build Windows
        if: steps.check_release.outputs.EXISTS == 'false'
        run: flutter build windows --release

      - name: Install Inno Setup
        if: steps.check_release.outputs.EXISTS == 'false'
        run: choco install innosetup -y

      - name: Create Installer
        if: steps.check_release.outputs.EXISTS == 'false'
        run: |
          # Run Inno Setup compiler with version parameter
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyAppVersion=${{ steps.version.outputs.VERSION }} installer\silver_stone.iss
        shell: pwsh

      - name: Update AppCast XML
        if: steps.check_release.outputs.EXISTS == 'false'
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $date = Get-Date -Format "ddd, dd MMM yyyy HH:mm:ss +0000"
          $repo = "${{ github.repository }}"

          $appcastContent = @"
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
            <channel>
              <title>Silver Stone Updates</title>
              <description>Latest updates for Silver Stone desktop app</description>
              <language>en</language>
              <item>
                <title>Version $version</title>
                <sparkle:version>$version</sparkle:version>
                <sparkle:shortVersionString>$version</sparkle:shortVersionString>
                <pubDate>$date</pubDate>
                <enclosure
                  url="https://github.com/$repo/releases/download/v$version/SilverStone-Setup-$version.exe"
                  sparkle:version="$version"
                  length="0"
                  type="application/octet-stream"/>
                <sparkle:releaseNotesLink>https://github.com/$repo/releases/tag/v$version</sparkle:releaseNotesLink>
              </item>
            </channel>
          </rss>
          "@

          $appcastContent | Out-File -FilePath docs\appcast.xml -Encoding utf8
        shell: pwsh

      - name: Commit AppCast Update
        if: steps.check_release.outputs.EXISTS == 'false'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/appcast.xml
          git diff --staged --quiet || git commit -m "chore: update appcast.xml for v${{ steps.version.outputs.VERSION }}"
          git push
        shell: pwsh

      - name: Create Release
        if: steps.check_release.outputs.EXISTS == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Version ${{ steps.version.outputs.VERSION }}
          body: |
            ## Silver Stone v${{ steps.version.outputs.VERSION }}

            Automated release from main branch.

            ### Installation
            1. Download `SilverStone-Setup-${{ steps.version.outputs.VERSION }}.exe` below
            2. Run the installer
            3. Follow the installation wizard

            ### Auto-Update
            If you already have Silver Stone installed, the app will automatically notify you of this update.
          files: |
            Output/SilverStone-Setup-${{ steps.version.outputs.VERSION }}.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip - Release already exists
        if: steps.check_release.outputs.EXISTS == 'true'
        run: echo "Release v${{ steps.version.outputs.VERSION }} already exists, skipping build"
